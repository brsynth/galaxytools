<tool id="retropath2" name="RetroPath2.0" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.09">
    <description>Build a reaction network from a set of source compounds to a set of sink compounds</description>
    <macros>
        <token name="@VERSION_SUFFIX@">0</token>
        <token name="@TOOL_VERSION@">2.3.0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">retropath2_wrapper</requirement>
    </requirements>
    <stdio>
        <exit_code range="1" level="fatal" description="Source has been found in the sink" />
        <exit_code range="2" level="fatal" description="Cannot find source-in-sink file" />
        <exit_code range="3" level="fatal" description="Running the RetroPath2.0 Knime program produced an OSError" />
        <exit_code range="4" level="warning" description="RetroPath2.0 has found no solution" />
        <exit_code range="5" level="warning" description="Time limit reached" />
	</stdio>
    <command detect_errors="exit_code"><![CDATA[
        python -m retropath2_wrapper
            '$sinkfile'
            '$rulesfile'
            out
            --source_inchi '$source_inchi'
            --source_name '$source_name'
            --rp2_version '$adv.version'
            --max_steps '$max_steps'
            --topx '$adv.topx'
            --dmin '$adv.dmin'
            --dmax '$adv.dmax'
            --mwmax_source '$adv.mwmax_source'
            --timeout '$adv.timeout' &&
        if compgen -G 'out/*_scope.csv' > /dev/null; then
            cp out/*_scope.csv '$Reaction_Network';
        else
            cp out/results.csv '$Reaction_Network';
        fi
    ]]></command>
    <inputs>
        <param name="rulesfile" type="data" format="csv,tar" label="Rules File" help="File containing reaction rules which reflect the enzymatic potential of the chassis organism"/>
        <param name="sinkfile" type="data" format="csv" label="Sink File" help=" Sink file which comprises all compounds that are considered as granted in your system."/>
        <param name="source_inchi" type="text" label="Source InChI" optional="false" help="InChI of compound to produce">>
            <validator type="empty_field" message="You must provide the InChI string"/>
        </param>
        <param name="max_steps" type="integer" value="3" min="1" max="10" label="Maximal Pathway length" help="Maximal number of steps"/>
        <param name="source_name" type="text" value="target" optional="true" label="Source name" help="Name of compound to produce"
            <validator type="empty_field" message="Source name is required"/>
        </param>
        <section name="adv" title="Advanced Options" expanded="false">
            <param name="version" type="select" label="Workflow version">
                <option value="v9">v9</option>
                <option value="r20210127">r20210127</option>
                <option value="r20220104" selected="true">r20220104</option>
            </param>
            <param name="topx" type="integer" value="100" min="1" max="1000" label="TopX" />
            <param name="dmin" type="integer" value="0" min="0" max="1000" label="Minimum rule diameter" help="Minimum rule diameter of the sphere including the atoms around the reacting center. The higher is the diameter, the more specific are the rules." />
            <param name="dmax" type="integer" value="1000" min="0" max="1000" label="Maximum rule diameter" help="Maximum rule diameter of the sphere including the atoms around the reacting center. The higher is the diameter, the more specific are the rules."/>
            <param name="mwmax_source" type="integer" value="1000" min="0" max="2000" label="Molecular weight of source (Da)" />
            <param name="timeout" type="integer" value="60" min="30" max="600" label="Timeout (min)" help="Timeout in minutes" />
        </section>
    </inputs>
    <outputs>
	    <data name="Reaction_Network" format="csv" label="${tool.name}" />
    </outputs>
    <tests>
        <test>
        <!-- test 1: check if identical outputs are produced with default parameters  -->
            <param name="rulesfile" value="rules.csv" />
            <param name="sinkfile" value="sink.csv" />
            <param name="source_inchi" value="InChI=1S/C6H6O4/c7-5(8)3-1-2-4-6(9)10/h1-4H,(H,7,8)(H,9,10)/p-2" />
            <output name="Reaction_Network" file="results_retropath2.csv" ftype="csv" compare="diff"/>
        </test>
    </tests>
    <help><![CDATA[
Retropath2.0 wrapper
====================


Perform retrosynthesis search of possible metabolic routes between a source molecule and a collection of sink molecules. This tool is an implementation of the `KNIME retropath2.0 workflow <https://www.myexperiment.org/workflows/4987.html>`_. It takes for input the minimal (dmin) and maximal (dmax) diameter for the reaction rules and the maximal path length (maxSteps). The tool expects the following files: rules.csv, sink.csv and source.csv and produce a retrosynthesis network as a CSV file providing reactions in the reaction SMILES format and chemicals in both SMILES and InChI formats along with other information like the score for each reaction. Only a single source molecule is processed at this time.

Input
-----

Required:

* **Sink File**\ : (string) Sink file which comprises all compounds that are considered as granted in your system.
* **Source InChI**\ : (string) InChI of compound to produce
* **Source name**\ : (string) Name of compound to produce
* **Maximal Pathway length**\ : (integer) Maximal number of steps
* **Rules File**\ : (string) File containing reaction rules which reflect the enzymatic potential of the chassis organism


Advanced options:

* **TopX**\ : (integer, default: 100) For each iteration, number of rules
* **Minimum rule diameter**\ : (integer, default: 0) Minimum rule diameter of the sphere including the atoms around the reacting center. The higher is the diameter, the more specific are the rules.
* **Maximum rule diameter**\ : (integer, default: 1000) Maximum rule diameter of the sphere including the atoms around the reacting center. The higher is the diameter, the more specific are the rules.
* **Molecular weight of source (Da)**\ : (integer, default: 1000) Molecular weight of source (Da)
* **Timeout (min)**\ : (integer, default: 30) Timeout in minutes

Output
------

* **Reaction Network**\ : (string) CSV file containing retrosynthesis network which provides reactions in the reaction SMILES format and chemicals in both SMILES and InChI formats along with other information like the score for each reaction.

Authors
-------

* **Joan HÃ©risson**
* Melchior du Lac

License
-------

This project is licensed under the MIT License.

Acknowledgments
---------------

* Thomas Duigou

    ]]></help>
    <citations>
        <citation type="doi">10.1016/j.ymben.2017.12.002 </citation>
    </citations>
</tool>